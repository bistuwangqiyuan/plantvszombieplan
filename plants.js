/**
 * plants.js - Ê§çÁâ©Á≥ªÁªü
 * ÂÆö‰πâÊâÄÊúâÊ§çÁâ©Á±ª„ÄÅÂ≠êÂºπÁ±ªÂíåÁõ∏ÂÖ≥ÈÄªËæë
 */

// Ê§çÁâ©Â±ûÊÄßÈÖçÁΩÆ
const PLANT_DATA = {
    sunflower: {
        id: 'sunflower',
        name: 'ÂêëÊó•Ëëµ',
        emoji: 'üåª',
        cost: 50,
        cooldown: 5000, // 5Áßí
        health: 100,
        damage: 0,
        attackInterval: 0,
        special: 'produce_sun',
        sunProduceInterval: 15000, // 15ÁßíÁîü‰∫ß‰∏ÄÊ¨°
        sunAmount: 50,
        description: 'ÂÆöÊúüÁîü‰∫ßÈò≥ÂÖâ'
    },
    peashooter: {
        id: 'peashooter',
        name: 'Ë±åË±ÜÂ∞ÑÊâã',
        emoji: 'üå±',
        cost: 100,
        cooldown: 5000,
        health: 150,
        damage: 20,
        attackInterval: 2000, // 2ÁßíÊîªÂáª‰∏ÄÊ¨°
        special: 'shoot',
        projectileType: 'normal',
        description: 'ÂèëÂ∞ÑË±åË±ÜÊîªÂáªÂÉµÂ∞∏'
    },
    wallnut: {
        id: 'wallnut',
        name: 'ÂùöÊûúÂ¢ô',
        emoji: 'ü•ú',
        cost: 50,
        cooldown: 20000, // 20Áßí
        health: 600,
        damage: 0,
        attackInterval: 0,
        special: 'defense',
        description: 'È´òË°ÄÈáèÈò≤Âæ°Ê§çÁâ©'
    },
    snowpea: {
        id: 'snowpea',
        name: 'ÂØíÂÜ∞Â∞ÑÊâã',
        emoji: '‚ùÑÔ∏è',
        cost: 175,
        cooldown: 7000, // 7Áßí
        health: 150,
        damage: 20,
        attackInterval: 2500, // 2.5ÁßíÊîªÂáª‰∏ÄÊ¨°
        special: 'shoot_ice',
        projectileType: 'ice',
        slowEffect: 0.5, // ÂáèÈÄü50%
        description: 'ÂèëÂ∞ÑÂÜ∞Ë±åË±ÜÔºåÂáèÈÄüÂÉµÂ∞∏'
    },
    cherrybomb: {
        id: 'cherrybomb',
        name: 'Ê®±Ê°ÉÁÇ∏Âºπ',
        emoji: 'üçí',
        cost: 150,
        cooldown: 30000, // 30Áßí
        health: 50,
        damage: 1800,
        attackInterval: 3000, // 3ÁßíÂêéÁàÜÁÇ∏
        special: 'explode',
        explodeRange: 1, // 3√ó3ËåÉÂõ¥ÔºàÂë®Âõ¥1Ê†ºÔºâ
        description: '‰∏ÄÊ¨°ÊÄßÁàÜÁÇ∏ÊîªÂáª'
    }
};

// Ê§çÁâ©Âü∫Á±ª
class Plant {
    constructor(id, row, col) {
        const data = PLANT_DATA[id];
        if (!data) {
            console.error('Invalid plant ID:', id);
            return;
        }

        this.id = id;
        this.name = data.name;
        this.emoji = data.emoji;
        this.row = row;
        this.col = col;
        this.health = data.health;
        this.maxHealth = data.health;
        this.damage = data.damage;
        this.attackInterval = data.attackInterval;
        this.special = data.special;
        
        // Êó∂Èó¥Áõ∏ÂÖ≥
        this.lastAttackTime = 0;
        this.createdTime = Date.now();
        this.lastSunProduceTime = Date.now();
        
        // Áä∂ÊÄÅ
        this.isAlive = true;
        this.element = null;
        
        // ÁâπÊÆäÂ±ûÊÄß
        this.projectileType = data.projectileType;
        this.slowEffect = data.slowEffect;
        this.explodeRange = data.explodeRange;
        this.sunProduceInterval = data.sunProduceInterval;
        this.sunAmount = data.sunAmount;
        
        this.createDOM();
    }

    /**
     * ÂàõÂª∫Ê§çÁâ©ÁöÑDOMÂÖÉÁ¥†
     */
    createDOM() {
        const pos = gridToScreen(this.row, this.col);
        
        this.element = document.createElement('div');
        this.element.className = 'plant-object';
        this.element.style.left = (pos.x - 30) + 'px';
        this.element.style.top = (pos.y - 40) + 'px';
        this.element.style.width = '60px';
        this.element.style.height = '80px';
        
        const emoji = document.createElement('span');
        emoji.className = 'plant-object-emoji';
        emoji.textContent = this.emoji;
        
        const healthBar = document.createElement('div');
        healthBar.className = 'health-bar';
        const healthBarFill = document.createElement('div');
        healthBarFill.className = 'health-bar-fill';
        healthBarFill.style.width = '100%';
        healthBar.appendChild(healthBarFill);
        
        this.element.appendChild(emoji);
        this.element.appendChild(healthBar);
        
        // Ê∑ªÂä†Âà∞ÊàòÂú∫
        document.getElementById('grid-container').appendChild(this.element);
        
        // Ê∑ªÂä†ÈïøÊåâÁßªÈô§ÂäüËÉΩ
        this.addRemoveHandler();
    }

    /**
     * Ê∑ªÂä†ÈïøÊåâÁßªÈô§Â§ÑÁêÜ
     */
    addRemoveHandler() {
        let pressTimer;
        
        const startPress = () => {
            pressTimer = setTimeout(() => {
                if (this.isAlive) {
                    showConfirm('ÁßªÈô§Ê§çÁâ©', 'Á°ÆÂÆöË¶ÅÁßªÈô§ËøôÊ†™Ê§çÁâ©ÂêóÔºüÔºà‰∏çËøîËøòÈò≥ÂÖâÔºâ', () => {
                        this.destroy();
                    });
                }
            }, 1000);
        };
        
        const cancelPress = () => {
            clearTimeout(pressTimer);
        };
        
        this.element.addEventListener('mousedown', startPress);
        this.element.addEventListener('mouseup', cancelPress);
        this.element.addEventListener('mouseleave', cancelPress);
        this.element.addEventListener('touchstart', startPress);
        this.element.addEventListener('touchend', cancelPress);
    }

    /**
     * Êõ¥Êñ∞Ê§çÁâ©Áä∂ÊÄÅ
     * @param {number} currentTime - ÂΩìÂâçÊó∂Èó¥Êà≥
     */
    update(currentTime) {
        if (!this.isAlive) return;

        // ÂêëÊó•ËëµÁîü‰∫ßÈò≥ÂÖâ
        if (this.special === 'produce_sun') {
            if (currentTime - this.lastSunProduceTime >= this.sunProduceInterval) {
                this.produceSun();
                this.lastSunProduceTime = currentTime;
            }
        }

        // Â∞ÑÂáªÁ±ªÊ§çÁâ©ÊîªÂáª
        if (this.special === 'shoot' || this.special === 'shoot_ice') {
            if (currentTime - this.lastAttackTime >= this.attackInterval) {
                if (this.canAttack()) {
                    this.shoot();
                    this.lastAttackTime = currentTime;
                }
            }
        }

        // Ê®±Ê°ÉÁÇ∏ÂºπÁàÜÁÇ∏
        if (this.special === 'explode') {
            if (currentTime - this.createdTime >= this.attackInterval) {
                this.explode();
            }
        }
    }

    /**
     * Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÊîªÂáªÔºàÂêåË°åÊòØÂê¶ÊúâÂÉµÂ∞∏Ôºâ
     */
    canAttack() {
        if (!window.gameState || !window.gameState.zombies) return false;
        return window.gameState.zombies.some(zombie => zombie.row === this.row && zombie.isAlive);
    }

    /**
     * ÂèëÂ∞ÑÂ≠êÂºπ
     */
    shoot() {
        const pos = gridToScreen(this.row, this.col);
        const projectile = new Projectile(
            this.projectileType || 'normal',
            this.row,
            pos.x + 30,
            pos.y,
            this.damage,
            this.slowEffect
        );
        
        if (window.gameState && window.gameState.projectiles) {
            window.gameState.projectiles.push(projectile);
        }
    }

    /**
     * Áîü‰∫ßÈò≥ÂÖâ
     */
    produceSun() {
        const pos = gridToScreen(this.row, this.col);
        createSun(pos.x, pos.y, this.sunAmount);
    }

    /**
     * Ê®±Ê°ÉÁÇ∏ÂºπÁàÜÁÇ∏
     */
    explode() {
        if (!this.isAlive) return;
        
        // ÂàõÂª∫ÁàÜÁÇ∏Âä®Áîª
        const explosion = document.createElement('div');
        explosion.textContent = 'üí•';
        explosion.style.position = 'absolute';
        explosion.style.fontSize = '5rem';
        explosion.style.left = this.element.style.left;
        explosion.style.top = this.element.style.top;
        explosion.style.animation = 'explode 0.5s ease-out forwards';
        explosion.style.pointerEvents = 'none';
        explosion.style.zIndex = '1000';
        document.getElementById('grid-container').appendChild(explosion);
        
        setTimeout(() => explosion.remove(), 500);
        
        // ÂØπËåÉÂõ¥ÂÜÖÁöÑÂÉµÂ∞∏ÈÄ†Êàê‰º§ÂÆ≥
        if (window.gameState && window.gameState.zombies) {
            window.gameState.zombies.forEach(zombie => {
                if (!zombie.isAlive) return;
                
                // ËÆ°ÁÆóË∑ùÁ¶ª
                const rowDiff = Math.abs(zombie.row - this.row);
                const zombieGridPos = screenToGrid(zombie.x, zombie.y);
                const colDiff = Math.abs(zombieGridPos.col - this.col);
                
                if (rowDiff <= this.explodeRange && colDiff <= this.explodeRange) {
                    zombie.takeDamage(this.damage);
                }
            });
        }
        
        this.destroy();
    }

    /**
     * ÂèóÂà∞‰º§ÂÆ≥
     * @param {number} damage - ‰º§ÂÆ≥ÂÄº
     */
    takeDamage(damage) {
        if (!this.isAlive) return;
        
        this.health -= damage;
        this.updateHealthBar();
        
        // Âèó‰º§Èó™ÁÉÅÊïàÊûú
        this.element.classList.add('flash');
        setTimeout(() => {
            if (this.element) {
                this.element.classList.remove('flash');
            }
        }, 300);
        
        if (this.health <= 0) {
            this.health = 0;
            this.die();
        }
    }

    /**
     * Êõ¥Êñ∞ÁîüÂëΩÂÄºÊù°
     */
    updateHealthBar() {
        if (!this.element) return;
        
        const healthBarFill = this.element.querySelector('.health-bar-fill');
        if (healthBarFill) {
            const percentage = (this.health / this.maxHealth) * 100;
            healthBarFill.style.width = percentage + '%';
            
            if (percentage <= 30) {
                healthBarFill.classList.add('low');
            }
        }
    }

    /**
     * Ê§çÁâ©Ê≠ª‰∫°
     */
    die() {
        this.isAlive = false;
        this.destroy();
        
        // Êõ¥Êñ∞ÁΩëÊ†ºÂç†Áî®Áä∂ÊÄÅ
        if (window.gameState && window.gameState.grid) {
            window.gameState.grid[this.row][this.col] = null;
        }
        
        // ÁªüËÆ°
        if (window.gameState) {
            window.gameState.plantsLost++;
        }
    }

    /**
     * ÈîÄÊØÅÊ§çÁâ©
     */
    destroy() {
        this.isAlive = false;
        if (this.element && this.element.parentNode) {
            this.element.remove();
        }
        
        // Êõ¥Êñ∞ÁΩëÊ†ºÂç†Áî®Áä∂ÊÄÅ
        if (window.gameState && window.gameState.grid) {
            window.gameState.grid[this.row][this.col] = null;
        }
    }
}

// Â≠êÂºπÁ±ª
class Projectile {
    constructor(type, row, x, y, damage, slowEffect = 0) {
        this.type = type; // 'normal' Êàñ 'ice'
        this.row = row;
        this.x = x;
        this.y = y;
        this.damage = damage;
        this.slowEffect = slowEffect;
        this.speed = 200; // ÂÉèÁ¥†/Áßí
        this.isAlive = true;
        this.element = null;
        
        this.createDOM();
    }

    /**
     * ÂàõÂª∫Â≠êÂºπÁöÑDOMÂÖÉÁ¥†
     */
    createDOM() {
        this.element = document.createElement('div');
        this.element.className = 'projectile-object projectile-' + this.type;
        this.element.style.left = this.x + 'px';
        this.element.style.top = this.y + 'px';
        
        document.getElementById('projectile-layer').appendChild(this.element);
    }

    /**
     * Êõ¥Êñ∞Â≠êÂºπ‰ΩçÁΩÆ
     * @param {number} deltaTime - Êó∂Èó¥Èó¥ÈöîÔºàÊØ´ÁßíÔºâ
     */
    update(deltaTime) {
        if (!this.isAlive) return;

        // ÂêëÂè≥ÁßªÂä®
        this.x += (this.speed * deltaTime) / 1000;
        
        if (this.element) {
            this.element.style.left = this.x + 'px';
        }

        // Ë∂ÖÂá∫Â±èÂπïÂàôÈîÄÊØÅ
        if (this.x > window.innerWidth + 50) {
            this.destroy();
        }
    }

    /**
     * Âáª‰∏≠ÁõÆÊ†á
     * @param {Zombie} zombie - Ë¢´Âáª‰∏≠ÁöÑÂÉµÂ∞∏
     */
    hit(zombie) {
        zombie.takeDamage(this.damage);
        
        if (this.type === 'ice' && this.slowEffect > 0) {
            zombie.applySlow(this.slowEffect, 3000); // ÂáèÈÄü3Áßí
        }
        
        this.destroy();
    }

    /**
     * ÈîÄÊØÅÂ≠êÂºπ
     */
    destroy() {
        this.isAlive = false;
        if (this.element && this.element.parentNode) {
            this.element.remove();
        }
    }
}

/**
 * Ëé∑ÂèñÊ§çÁâ©Êï∞ÊçÆ
 * @param {string} plantId - Ê§çÁâ©ID
 * @returns {Object} Ê§çÁâ©Êï∞ÊçÆ
 */
function getPlantData(plantId) {
    return PLANT_DATA[plantId];
}

/**
 * Ëé∑ÂèñÊâÄÊúâÊ§çÁâ©Êï∞ÊçÆ
 * @returns {Object} ÊâÄÊúâÊ§çÁâ©Êï∞ÊçÆ
 */
function getAllPlantData() {
    return PLANT_DATA;
}

/**
 * ÂàõÂª∫Ê§çÁâ©ÂÆû‰æã
 * @param {string} plantId - Ê§çÁâ©ID
 * @param {number} row - Ë°åÂè∑Ôºà0-4Ôºâ
 * @param {number} col - ÂàóÂè∑Ôºà0-2Ôºâ
 * @returns {Plant} Ê§çÁâ©ÂÆû‰æã
 */
function createPlant(plantId, row, col) {
    return new Plant(plantId, row, col);
}

